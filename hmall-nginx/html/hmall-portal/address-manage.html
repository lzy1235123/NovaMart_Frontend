<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Management - Hmall</title>
    <style>
        /* ‰øùÊåÅÂéüÊúâÁöÑCSSÊ†∑Âºè‰∏çÂèò */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .back-btn {
            font-size: 18px;
            color: #333;
            text-decoration: none;
            margin-right: 15px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
        }

        .address-list {
            margin-bottom: 30px;
        }

        .address-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }

        .address-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .contact-info {
            font-weight: 600;
            font-size: 16px;
        }

        .mobile {
            margin-left: 15px;
            color: #666;
        }

        .address-detail {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .address-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .default-tag {
            background: #ff4d4f;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            color: #1890ff;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn {
            color: #ff4d4f;
        }

        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff4d4f, #ff7875);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 77, 79, 0.3);
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(255, 77, 79, 0.4);
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1890ff;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input {
            width: auto;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #999;
        }

        /* Âú∞Âå∫ÈÄâÊã©Âô®Ê†∑Âºè */
        .region-selectors {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .region-selectors select {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .region-selectors select:focus {
            outline: none;
            border-color: #1890ff;
        }
    </style>
</head>
<body>
<div id="addressApp">
    <div class="container">
        <div class="header">
            <a href="/user-info.html" class="back-btn">‚Üê</a>
            <h1 class="page-title">Address Management</h1>
        </div>

        <div class="address-list">
            <div v-if="addressList.length === 0" class="empty-state">
                <div class="empty-icon">üìç</div>
                <div class="empty-text">ÊöÇÊó†Êî∂Ë¥ßÂú∞ÂùÄ</div>
                <div class="empty-subtext">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏Ä‰∏™Êî∂Ë¥ßÂú∞ÂùÄ</div>
            </div>

            <div v-for="addr in addressList" :key="addr.id" class="address-item">
                <div class="address-header">
                    <div class="contact-info">
                        {{addr.contact}}
                        <span class="mobile">{{handleMobile(addr.mobile)}}</span>
                    </div>
                </div>
                <div class="address-detail">
                    {{addr.province}}{{addr.city}}{{addr.town}}{{addr.street}}
                </div>
                <div class="address-footer">
                    <div>
                        <span v-if="addr.isDefault" class="default-tag">default</span>
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" @click="editAddress(addr)">edit</button>
                        <button class="delete-btn" @click="deleteAddress(addr.id)">remove</button>
                    </div>
                </div>
            </div>
        </div>

        <button class="add-btn" @click="showAddForm = true">+</button>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÂú∞ÂùÄÊ®°ÊÄÅÊ°Ü -->
    <div v-if="showAddForm || editingAddress" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">{{editingAddress ? 'edit address' : 'add address'}}</h3>
                <button class="close-btn" @click="closeModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Contact</label>
                    <input v-model="currentAddress.contact" type="text" placeholder="Enter contact name">
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input v-model="currentAddress.mobile" type="text" placeholder="Enter mobile number">
                </div>

                <!-- ‰øÆÊîπÂú∞Âå∫ÈÄâÊã©ÈÉ®ÂàÜ -->
                <div class="form-group">
                    <label>Region</label>
                    <div class="region-selectors">
                        <select v-model="currentAddress.province" @change="onProvinceChange">
                            <option value="">-- Select Province --</option>
                            <option v-for="province in provinces" :key="province" :value="province">{{province}}</option>
                        </select>
                        <select v-model="currentAddress.city" @change="onCityChange" :disabled="!currentAddress.province">
                            <option value="">-- Select City --</option>
                            <option v-for="city in cities" :key="city" :value="city">{{city}}</option>
                        </select>
                        <select v-model="currentAddress.town" :disabled="!currentAddress.city">
                            <option value="">-- Select Town --</option>
                            <option v-for="town in towns" :key="town" :value="town">{{town}}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Street</label>
                    <input v-model="currentAddress.street" type="text" placeholder="Enter street">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input v-model="currentAddress.notes" type="text" placeholder="Additional notes (optional)">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" v-model="currentAddress.isDefault" :true-value="1" :false-value="0">
                    <label>ËÆæ‰∏∫ÈªòËÆ§Âú∞ÂùÄ</label>
                </div>

                <div class="form-actions">
                    <button class="btn btn-secondary" @click="closeModal">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" @click="saveAddress">{{editingAddress ? '‰øùÂ≠ò' : 'Ê∑ªÂä†'}}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<script src="js/common.js"></script>
<!-- ÂºïÂÖ•Âú∞Âå∫Êï∞ÊçÆ -->
<script src="js/region-data.js"></script>

<script>
    new Vue({
        el: '#addressApp',
        data() {
            return {
                addressList: [],
                showAddForm: false,
                editingAddress: null,
                currentAddress: {
                    contact: '',
                    mobile: '',
                    province: '',
                    city: '',
                    town: '',
                    street: '',
                    notes: '',
                    isDefault: 0
                },
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑÂú∞Âå∫Êï∞ÊçÆ
                regionData: regionData,
                provinces: [],
                cities: [],
                towns: []
            }
        },
        created() {
            this.getAddressList();
            this.initProvinces();
        },
        methods: {
            // ÂàùÂßãÂåñÁúÅ‰ªΩÂàóË°®
            initProvinces() {
                this.provinces = Object.keys(this.regionData);
            },

            getAddressList() {
                // ‰ªéÊúçÂä°Âô®Ëé∑ÂèñÂú∞ÂùÄÂàóË°®
                axios.get("/addresses")
                    .then(resp => {
                        if (resp) {
                            this.addressList = resp;
                        } else {
                            // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                            this.addressList = [
                                {
                                    "id": 61,
                                    "userId": 2,
                                    "contact": "Êùé‰Ω≥ÂÖ¥",
                                    "mobile": "13301212233",
                                    "province": "‰∏äÊµ∑Â∏Ç",
                                    "city": "‰∏äÊµ∑Â∏Ç",
                                    "town": "Êµ¶‰∏úÊñ∞Âå∫",
                                    "street": "Ëà™Â§¥ÈïáËà™Â§¥Ë∑Ø123Âè∑",
                                    "notes": "",
                                    "isDefault": 1
                                },
                                {
                                    "id": 63,
                                    "userId": 2,
                                    "contact": "ÊùéÂ∞èÈæô",
                                    "mobile": "13301212233",
                                    "province": "Âπø‰∏úÁúÅ",
                                    "city": "‰ΩõÂ±±Â∏Ç",
                                    "town": "È°∫Âæ∑Âå∫",
                                    "street": "Ê∞∏Êò•Ê≠¶ÊúØÂ≠¶Ê†°",
                                    "notes": "",
                                    "isDefault": 0
                                }
                            ];
                        }
                    })
                    .catch(err => {
                        console.error("Ëé∑ÂèñÂú∞ÂùÄÂàóË°®Â§±Ë¥•:", err);
                        // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                        this.addressList = [
                            {
                                "id": 61,
                                "userId": 2,
                                "contact": "Êùé‰Ω≥ÂÖ¥",
                                "mobile": "13301212233",
                                "province": "‰∏äÊµ∑Â∏Ç",
                                "city": "‰∏äÊµ∑Â∏Ç",
                                "town": "Êµ¶‰∏úÊñ∞Âå∫",
                                "street": "Ëà™Â§¥ÈïáËà™Â§¥Ë∑Ø123Âè∑",
                                "notes": "",
                                "isDefault": 1
                            }
                        ];
                    });
            },

            editAddress(address) {
                this.editingAddress = address;
                this.currentAddress = {...address};
                // ÁºñËæëÊó∂ÂàùÂßãÂåñÂØπÂ∫îÁöÑÂüéÂ∏ÇÂíåÂå∫ÂéøÂàóË°®
                this.onProvinceChange(true);
                this.onCityChange(true);
            },

            deleteAddress(addressId) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Âú∞ÂùÄÂêóÔºü')) {
                    axios.delete(`/addresses/${addressId}`)
                        .then(() => {
                            this.getAddressList();
                        })
                        .catch(err => {
                            console.error("Âà†Èô§Âú∞ÂùÄÂ§±Ë¥•:", err);
                            // Ê®°ÊãüÂà†Èô§ÊàêÂäü
                            this.addressList = this.addressList.filter(addr => addr.id !== addressId);
                        });
                }
            },

            saveAddress() {
                // Ë°®ÂçïÈ™åËØÅ
                if (!this.validateForm()) {
                    return;
                }

                if (this.editingAddress) {
                    // Êõ¥Êñ∞Âú∞ÂùÄ
                    axios.put(`/addresses/${this.editingAddress.id}`, this.currentAddress)
                        .then(() => {
                            this.closeModal();
                            this.getAddressList();
                        })
                        .catch(err => {
                            console.error("Êõ¥Êñ∞Âú∞ÂùÄÂ§±Ë¥•:", err);
                            alert("Êõ¥Êñ∞Âú∞ÂùÄÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
                        });
                } else {
                    // Êñ∞Â¢ûÂú∞ÂùÄ
                    axios.post("/addresses", this.currentAddress)
                        .then(() => {
                            this.closeModal();
                            this.getAddressList();
                        })
                        .catch(err => {
                            console.error("Ê∑ªÂä†Âú∞ÂùÄÂ§±Ë¥•:", err);
                            alert("Ê∑ªÂä†Âú∞ÂùÄÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
                        });
                }
            },

            validateForm() {
                if (!this.currentAddress.contact) {
                    alert("ËØ∑ËæìÂÖ•Êî∂Ë¥ß‰∫∫ÂßìÂêç");
                    return false;
                }
                if (!this.currentAddress.mobile || !/^1[3-9]\d{9}$/.test(this.currentAddress.mobile)) {
                    alert("ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Á†Å");
                    return false;
                }
                if (!this.currentAddress.province || !this.currentAddress.city || !this.currentAddress.town) {
                    alert("ËØ∑ÈÄâÊã©ÂÆåÊï¥ÁöÑÊâÄÂú®Âú∞Âå∫");
                    return false;
                }
                if (!this.currentAddress.street) {
                    alert("ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄ");
                    return false;
                }
                return true;
            },

            closeModal() {
                this.showAddForm = false;
                this.editingAddress = null;
                this.resetCurrentAddress();
                this.cities = [];
                this.towns = [];
            },

            resetCurrentAddress() {
                this.currentAddress = {
                    contact: '',
                    mobile: '',
                    province: '',
                    city: '',
                    town: '',
                    street: '',
                    notes: '',
                    isDefault: 0
                };
            },

            // ÁúÅ‰ªΩÊîπÂèòÊó∂Êõ¥Êñ∞ÂüéÂ∏ÇÂàóË°®
            onProvinceChange(isEdit = false) {
                if (this.currentAddress.province) {
                    const provinceData = this.regionData[this.currentAddress.province];
                    this.cities = Object.keys(provinceData || {});

                    if (!isEdit) {
                        this.currentAddress.city = '';
                        this.currentAddress.town = '';
                        this.towns = [];
                    } else {
                        // ÁºñËæëÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûúÂΩìÂâçÂüéÂ∏Ç‰∏çÂú®Êñ∞ÁúÅ‰ªΩÁöÑÂüéÂ∏ÇÂàóË°®‰∏≠ÔºåÊ∏ÖÁ©∫ÂüéÂ∏Ç
                        if (this.currentAddress.city && !this.cities.includes(this.currentAddress.city)) {
                            this.currentAddress.city = '';
                            this.currentAddress.town = '';
                            this.towns = [];
                        }
                    }
                } else {
                    this.cities = [];
                    this.currentAddress.city = '';
                    this.currentAddress.town = '';
                    this.towns = [];
                }
            },

            // ÂüéÂ∏ÇÊîπÂèòÊó∂Êõ¥Êñ∞Âå∫ÂéøÂàóË°®
            onCityChange(isEdit = false) {
                if (this.currentAddress.province && this.currentAddress.city) {
                    const provinceData = this.regionData[this.currentAddress.province];
                    this.towns = provinceData[this.currentAddress.city] || [];

                    if (!isEdit) {
                        this.currentAddress.town = '';
                    } else {
                        // ÁºñËæëÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûúÂΩìÂâçÂå∫Âéø‰∏çÂú®Êñ∞Âå∫ÂéøÂàóË°®‰∏≠ÔºåÊ∏ÖÁ©∫Âå∫Âéø
                        if (this.currentAddress.town && !this.towns.includes(this.currentAddress.town)) {
                            this.currentAddress.town = '';
                        }
                    }
                } else {
                    this.towns = [];
                    this.currentAddress.town = '';
                }
            },

            handleMobile(mobile) {
                return mobile ? mobile.substring(0, 3) + '****' + mobile.substring(7) : '';
            }
        }
    });
</script>
</body>
</html>