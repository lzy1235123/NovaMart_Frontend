<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
  <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
  <title>Payment</title>
  <link rel="stylesheet" type="text/css" href="./css/webbase.css"/>
  <link rel="stylesheet" type="text/css" href="./css/pay.css"/>
  <link rel="stylesheet" type="text/css" href="./css/pages-weixinpay.css"/>
</head>

<body>
<!--head-->
<div id="payApp">
  <top></top>
  <div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
      <a href="/">
        <div class="logo">
          <img src="./img/logo.png" alt="1"/>
        </div>
      </a>
      <span>Cashier</span>
    </div>
    <!--Main Content-->
    <div class="checkout py-container  pay">
      <div class="checkout-tit">
        <h4 class="fl tit-txt">
          <span class="success-icon"></span>
          <span class="success-info">Order submitted successfully, order number: {{order.id}}. Please pay in time, the order will be cancelled after
          <span style="color: #9d261d">{{remainTime}}</span>.</span>
        </h4>
        <span class="fr">
						<em class="sui-lead">Amount payable:</em>
						<em class="orange money">¥{{util.formatPrice(order.totalFee)}}</em></span>
        <div class="clearfix"></div>
      </div>
      <div class="checkout-steps">
        <div class="container">
          <div class="tab-wrapper">
            <!--tab section 1-->
            <div style="padding: 15px 20px 15px 20px">
              <input type="radio" name="tab-radio" v-model="tab" :value="1" class="tab-radio" id="tab-radio-1" checked>
              <label for="tab-radio-1" class="tab-handler tab-handler-1"
                     :class='{"tab-selected": tab === 1}'>Alipay</label>
              <!--tab section 2-->
              <input type="radio" name="tab-radio" v-model="tab" :value="2" id="tab-radio-2" class="tab-radio">
              <label for="tab-radio-2" class="tab-handler tab-handler-2"
                     :class='{"tab-selected": tab === 2}'>WeChat Pay</label>
              <!--tab section 3-->
              <input type="radio" name="tab-radio" v-model="tab" :value="3" id="tab-radio-3" class="tab-radio">
              <label for="tab-radio-3" class="tab-handler tab-handler-3"
                     :class='{"tab-selected": tab === 3}'>Balance Payment</label>
            </div>
            <div class="hr"></div>
            <div class="tab-content" style="padding: 10px 20px" v-show="tab === 1 || tab === 2">
              <div class="fl sao">
                <div class="fl code">
                  <div id="qrImage2">
                    <img src="./img/erweima.png" alt="">
                  </div>
                  <div class="saosao">
                    <p>Please use {{paymentTypes[tab - 1].label}} to scan</p>
                    <p>Scan QR code to pay</p>
                  </div>
                </div>
                <div class="fl phone">

                </div>

              </div>
            </div>
            <div class="tab-content" v-show="tab === 3" style="padding: 10px 20px">

              <label for="payPassword">Please enter payment password:</label>
              <input id="payPassword" type="password" v-model="password">

              <button @click="payByBalance">Confirm Payment</button>
            </div>
          </div>
        </div>
        <div class="clearfix"></div>
      </div>
    </div>

  </div>
</div>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<script src="js/common.js"></script>
<script src="js/top.js"></script>
<script src="js/qrcode.min.js"></script>
<script>
  let app = new Vue({
    el: "#payApp",
    data() {
      return {
        util, // Utility class
        order: {id: 458010519, totalFee: 298400, paymentType: 3}, // Order information
        paymentTypes: [{value: "aliPay", label: "Alipay"}, {value: "wxPay", label: "WeChat"}, {value: "balance", label: "Balance"}], // Payment methods
        tab: 3, // Tab page
        password: "", // Payment password
        remainTime: "",
        user: null,
        payOrderNo: "", // Payment order number
      }
    },
    created() {
      util.store.set("return-url", location.href);
      this.user = util.store.get("user-info")
      // Query order
      axios.get("/orders/" + util.getUrlParam("id"))
              .then(resp => {
                // Order found
                this.order = resp;
                this.tab = this.order.paymentType;
                // Create payment order
                this.createPayOrder(this.order.id);
                // Set countdown
                const deadLine = new Date(this.order.createTime).getTime() + 1800000;
                const tid = setInterval(() => {
                  const remainTime = deadLine - new Date().getTime();
                  this.remainTime = Math.floor(remainTime / 60000) + " min " + Math.floor((remainTime % 60000) / 1000) + " sec";
                })
                setTimeout(() => {
                  // Clear countdown
                  clearInterval(tid)
                  // Redirect to failure page
                  alert("Payment timeout!");
                }, deadLine - new Date().getTime())
              })
              .catch(err => console.log(err));
    },
    watch: {
      tab(val) {
        // Create payment order
        this.createPayOrder(this.order.id);
      }
    },
    methods: {
      createPayOrder(id) {
        axios.post("/pay-orders",
                {
                  bizOrderNo: this.order.id,
                  amount: this.order.totalFee,
                  payType: this.tab === 3 ? 5 : 4,
                  orderInfo: "Hmall products",
                  payChannelCode: this.paymentTypes[this.tab - 1].value
                },
                {
                  transformResponse: data => data
                }
        ).then(resp => {
          // Check payment method
          if (this.tab === 3) {
            // Balance payment, save transaction number only
            this.payOrderNo = resp;
            return;
          }
          // Scan payment, generate QR code
          new QRCode(document.getElementById("qrImage"), {
            text: resp,
            width: 250,
            height: 250,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          // Start定时task, check payment status
          const taskId = setInterval(() => {
            this.queryOrderStatus(taskId);
          }, 3000);
          // Also set a定时task, after 5 minutes, actively query payment result from WeChat, if still failed, terminate query, consider payment failed
          setTimeout(() => {
            // Clear previous定时task
            clearInterval(taskId);
            // Actively query payment status
            this.queryPayStatus();
          }, 300000)
        })
                .catch(err => console.log(err));
      },
      queryOrderStatus(taskId) {
        axios.get("/order/status/" + id)
                .then(resp => {
                  let i = resp;
                  if (i === 5) {
                    // Payment failed
                    clearInterval(taskId);
                    // Redirect to payment failure page
                    alert("Payment failed, please try again!")
                  } else if (i !== 1) {
                    // Payment successful
                    clearInterval(taskId);
                    // Redirect to payment success page
                    location.href = "/paysuccess.html?orderId=" + id;
                  }
                }).catch((e) => {
          alert("Payment status query failed, please refresh the page and try again.");
          clearInterval(taskId);
        })
      },
      queryPayStatus() {
        axios.get("/pay/status/" + id)
                .then(resp => {
                  // resp is the returned status, 1 means unpaid, 2 means paid, 3 means payment failed, 4 means paying
                  if (resp !== 2) {
                    // Unpaid or payment failed, redirect to failure page
                    alert("Payment failed, please try again!")
                  }
                  // Already paid, redirect to payment success page
                  location.href = "/paysuccess.html?orderId=" + id;
                })
                .catch(err => {
                  console.log(err)
                  alert("Payment failed, please try again!")
                })
      },
      payByBalance() {
        if(!this.payOrderNo){
          alert("Transaction number is empty")
          return;
        }
        axios.post("/pay-orders/" + this.payOrderNo,
                {id: this.payOrderNo, pw: this.password},{
                  transformResponse: data => data
                })
                .then(() => {
                  // Already paid, redirect to payment success page
                  location.href = "/paysuccess.html?orderId=" + this.order.id;
                })
                .catch(err => {
                  console.log(err)
                  alert("Payment failed, please try again!")
                })
      }
    }
  });
</script>
</body>

</html>
